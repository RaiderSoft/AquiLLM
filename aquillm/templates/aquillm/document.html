{% extends "aquillm/base.html" %}
{% load tz %}

{% block title %}AquiLLM {{ document.title }}{% endblock %}

{% block content %}
<div class="w-full h-full">
<h1 class="text-2xl">{{ document.title|default:"Untitled Document" }}</h1>
<details>
    <summary class="font-black">Details</summary>
    <ul>
        <li><span class="font-black">Collection:</span> {{ document.collection.name }}</li>
        <li><span class="font-black">Ingested By:</span> {{ document.ingested_by }}</li>
        <li><span class="font-black">Date Ingested:</span> {{ document.ingestion_date|localtime|date:"F j, Y, g:i a e" }}</li>
    </ul>
</details>
{% if document.pdf_file %}
<iframe src="{% url 'pdf' document.id %}" class="w-full h-full"></iframe>
{% else %}
<h1 class ="text-xl w-full">Full Text:</h1>
<div>
    {{ document.original_text|linebreaks }}
</div>

{% if document.has_latex %}
<h1 class="text-xl w-full mt-6">LaTeX Version:</h1>

<!-- 
  LaTeX rendering section
-->
<div class="bg-white p-4 rounded-lg mb-4 latex-render">
    {{ document.latex_content|linebreaks|safe }}
</div>

<!-- 
  KaTeX library imports for LaTeX rendering
-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

<!-- 
  Collapsible section for raw LaTeX code
-->
<details class="mt-2">
    <summary class="cursor-pointer text-blue-600 hover:text-blue-800">View Raw LaTeX Code</summary>
    <div class="bg-gray-100 p-4 rounded-lg mt-2">
        <pre class="whitespace-pre-wrap">{{ document.latex_content }}</pre>
    </div>
</details>

<!-- 
  JavaScript to initialize KaTeX rendering
-->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Add small delay to ensure content is fully loaded
        setTimeout(function() {
            // Find and render all math expressions in the LaTeX content area
            renderMathInElement(document.querySelector('.latex-render'), {
                // Define which delimiters indicate math expressions
                delimiters: [
                    {left: "$$", right: "$$", display: true},  // Display mode (centered, larger)
                    {left: "$", right: "$", display: false},   // Inline mode
                    {left: "\\(", right: "\\)", display: false},  // Alternative inline
                    {left: "\\[", right: "\\]", display: true}    // Alternative display
                ],
                throwOnError: false  // Continue rendering even if there are errors
            });
        }, 500);  // 500ms delay
    });
</script>
{% endif %}
{% endif %}
</div>
{% endblock %}
{% extends "aquillm/base.html" %}

{% block content %}
<div class="flex flex-col-reverse h-full max-h-full items-center">
    
    <div class="border-t border-gray-shade_6 w-[80%] mb-[32px] flex flex-col items-center">
        
        <div id="exception-box" class="sticky top-0 z-50 font-mono text-red-700"></div>
        
        <div class="flex justify-start flex-col mt-[32px] gap-[8px] bg-gray-shade_3 p-4 rounded-[32px] w-[80%]">
            <div class="flex flex-grow items-center w-full ">
                <input 
                    type="text" 
                    id="message-input"
                    style="color: #eeeeee; font-family: sans-serif;"
                    class="px-4 py-2 mr-[16px] flex-grow w-full rounded-lg bg-gray-shade_3 b focus:border-0 disabled:cursor-not-allowed placeholder:text-gray-shade_7 placeholder:font-sans "
                    placeholder="Type your message here..."
                    autocomplete="off"
                />

                <button 
                    id="send-button"
                    class="p-4 bg-accent text-gray-shade_e rounded-[24px] disabled:cursor-not-allowed"
                    title="Send Message"
                    >
                    
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_42_63)">
                        <path d="M14.3246 5.31061L6.51295 0.643942C5.90283 0.280198 5.1809 0.0611376 4.42721 0.0110503C3.67351 -0.0390371 2.9175 0.0818059 2.24301 0.36018C1.56852 0.638553 1.0019 1.06358 0.60598 1.58813C0.210062 2.11268 0.000316079 2.71626 0 3.33194V12.6653C0.000134919 13.2812 0.209892 13.8851 0.605993 14.4099C1.00209 14.9347 1.56905 15.3599 2.24393 15.6382C2.91881 15.9166 3.67523 16.0372 4.42924 15.9868C5.18324 15.9364 5.90535 15.7169 6.51541 15.3526L14.327 10.6859C14.8456 10.3763 15.2672 9.97165 15.5579 9.50465C15.8485 9.03765 16 8.52148 16 7.99794C16 7.47441 15.8485 6.95823 15.5579 6.49124C15.2672 6.02424 14.8456 5.61954 14.327 5.30994L14.3246 5.31061ZM13.3551 9.61061L5.54346 14.2773C5.17746 14.495 4.74458 14.6261 4.29276 14.6559C3.84093 14.6858 3.38778 14.6132 2.98345 14.4464C2.57912 14.2795 2.2394 14.0248 2.00187 13.7104C1.76435 13.3961 1.63829 13.0343 1.63765 12.6653V3.33194C1.63311 2.96217 1.75679 2.59886 1.99448 2.28376C2.23217 1.96865 2.57423 1.71454 2.98135 1.55061C3.32762 1.4072 3.71055 1.33229 4.09905 1.33194C4.61973 1.33356 5.12603 1.4712 5.54346 1.72461L13.3551 6.39127C13.6658 6.57707 13.9185 6.81981 14.0926 7.09985C14.2668 7.3799 14.3575 7.68938 14.3575 8.00327C14.3575 8.31717 14.2668 8.62665 14.0926 8.9067C13.9185 9.18674 13.6658 9.42948 13.3551 9.61528V9.61061Z" fill="#EEEEEE"/>
                        </g>
                    </svg>

                </button>
            </div>

            <!-- Collections Section -->
            <div class="mb-2">
                <details class="w-full">
                    <summary class="cursor-pointer w-[max-content] ml-4 px-[16px] py-[2px] text-gray-shade_e font-sans bg-accent h-[36px] rounded-[18px] flex items-center">
                        <span>Select Collections</span>
                        <span class="ml-2 text-sm text-gray-500" id="selected-count"></span>
                    </summary>
                    <div class="mt-2 p-2 border rounded-lg bg-white" id="collections-list">
                        <!-- Collections will be dynamically inserted here -->
                    </div>
                </details>
            </div>
        </div>
    </div>
    <!-- the style tag on this adds a small but noticeable "fade" to the chat bubbles as the user scrolls down in the conversation -->
    <div class="w-[80%] overflow-y-auto h-full max-h-full px-[32px] pt-[32px] mt-[32px]" style="mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 5%); -webkit-mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 5%);">
        <div id="conversation-root">

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { init, classModule, propsModule, styleModule, eventListenersModule, attributesModule, h } from 'https://cdn.jsdelivr.net/npm/snabbdom@3.6.2/+esm';
    
    const patch = init([
    classModule,
    propsModule,
    styleModule,
    eventListenersModule, 
    attributesModule
    ]);
    
    const convo_id = "{{ convo_id }}"
    
    let exceptionVnode = document.getElementById('exception-box');
    
    function updateExceptionBox(exception) {
        const newVnode = h('div', {
            class: {
                'font-mono': true,
                'text-red-700': true,
                'p-4': true,
                'mb-4': true,
                'bg-red-100': true,
                'rounded': true,
                'hidden': !exception,
            }
        }, exception || '');
        
        exceptionVnode = patch(exceptionVnode, newVnode);
    }
    
    let collections = []

    
    
    function createSpinner() {
        return h('div', {
            class: {
                'flex': true,
                'justify-center': true,
                'my-4': true
            }
        }, [
        h('div', {
            class: {
                'animate-spin': true,
                'rounded-full': true,
                'h-8': true,
                'w-8': true,
                'border-4': true,
                'border-blue-500': true,
                'border-t-transparent': true
            }
        })
        ]);
    }
    
    function createCollapsible(summary, summaryTextColor, content, isOpen = false) {
        return h('details', {
            props: { open: isOpen },
            class: { 'mt-1.5': true }
        }, [
        h('summary', {
            class: {
                'cursor-pointer': true,
                summaryTextColor: true
            }
        }, summary),
        h('div', {
            class: {
                'mt-1.5': true,
                'pl-2.5': true,
                'border-l-2': true,
                'border-gray-300': true
            }
        }, content)
        ]);
    }
    
    function renderToolResult(result, level = 0) {
        if (typeof result === 'object' && result !== null) {
            if (Array.isArray(result)) {
                return h('details', {
                    props: { open: level < 1 },
                    class: { 'mt-1': true }
                }, [
                h('summary', {
                    class: {
                        'cursor-pointer': true,
                        'font-mono': true,
                        'hover:text-blue-600': true
                    }
                }, 'Array'),
                h('div', { 
                    class: { 
                        'pl-4': true,
                        'border-l-2': true,
                        'border-gray-300': true,
                        'mt-1': true
                    } 
                }, result.map(item => renderToolResult(item, level + 1)))
                ]);
            } else {
                return h('div', {}, 
                Object.entries(result).map(([key, value]) => 
                typeof value === 'object' && value !== null ?
                h('details', {
                    props: { open: level < 1 },
                    class: { 'mt-1': true }
                }, [
                h('summary', {
                    class: {
                        'cursor-pointer': true,
                        'font-mono': true,
                        'hover:text-blue-600': true
                    }
                }, key),
                h('div', { 
                    class: { 
                        'pl-4': true,
                        'border-l-2': true,
                        'border-gray-300': true,
                        'mt-1': true
                    } 
                }, renderToolResult(value, level + 1))
                ]) :
                h('div', { class: { 'mt-1': true } }, [
                h('span', { 
                    class: { 
                        'font-mono': true,
                        'text-blue-600': true
                    } 
                }, `${key}: `),
                renderToolValue(value)
                ])
                )
                );
            }
        }
        return renderToolValue(result);
    }
    
    function renderToolValue(value) {
        if (typeof value === 'string') {
            return h('span', { 
                class: { 
                    'font-mono': true,
                    'text-gray-shade_e': true // used to be text-green-600
                } 
            }, `"${value}"`);
        }
        return h('span', { 
            class: { 
                'font-mono': true,
                'text-secondary_accent-light': true // used to be text-purple-600
            } 
        }, String(value));
    }
    
    function shouldShowSpinner(messages) {
        if (messages.length === 0) return false;
        const lastMessage = messages[messages.length - 1];
        return (
        lastMessage.role === 'user' ||
        (lastMessage.role === 'assistant' && lastMessage.tool_call_input) ||
        (lastMessage.role === 'tool' && lastMessage.for_whom === 'assistant')
        );
    }
    function createRatingButtons(message, index) {
        const emojis = ['ðŸ˜ž', 'ðŸ˜•', 'ðŸ˜', 'ðŸ™‚', 'ðŸ˜Š'];
        const rating = message.rating || 0;
        
        return h('div', { 
            class: {
                'flex': true,
                'items-center': true,
                'gap-1': true,
                'mt-2': true
            }
        }, [
            h('span', { class: { 'text-sm': true, 'mr-2': true } }, 'Rate:'),
            ...emojis.map((emoji, i) => 
                h('button', {
                    class: {
                        'p-1': true,
                        'rounded': true,
                        'hover:bg-gray-200': true,
                        'bg-gray-200': rating === i + 1,
                        'transition-colors': true
                    },
                    on: {
                        click: () => {
                            conversation.messages[index].rating = i + 1;
                            rateMessage(message.message_uuid, i + 1);
                            updateConversation(conversation);
                        }
                    }
                }, emoji)
            )
        ]);
    }

    function renderConversation(data) {
        const content = [
        ...data.messages.map((message, index) => {
            const messageClasses = {
                'w-4/5': true,
                'p-2.5': true,
                'rounded-[12px]': true,
                'shadow-md': true,
                'whitespace-pre-wrap': true,
                'break-words': true,
                'font-sans': true
            };
            
            if (message.role === 'user') {
                Object.assign(messageClasses, {
                    'user-message': true,
                    'self-end': true,
                    'bg-gray-shade_4': true,
                    'text-gray-shade_e': true
                });
            } else if (message.role === 'assistant') {
                Object.assign(messageClasses, {
                    'assistant-message': true, 
                    'text-gray-shade_e': true,
                    'bg-accent': true
                });
            } else if (message.role === 'tool') {
                Object.assign(messageClasses, {
                    'bg-secondary_accent': true,
                    'border': true,
                    'border-1': true,
                    'border-secondary_accent-light': true,
                    'text-gray-shade_e': true
                });
            }
            
            const content = [];

            if (message.role !== 'tool') {
                content.push(h('p', { 
                    class: { 
                        'whitespace-pre-wrap': true,
                        'break-words': true
                    }
                }, message.content));
            }                
            
            if (message.role === 'assistant' && message.tool_call_input) {
                content.push(h('div', { 
                    class: { 
                        'mt-2.5': true,
                        'text-sm': true
                    }
                }, [
                h('strong', {}, `Called Tool: ${message.tool_call_name}`),
                createCollapsible('View Tool Arguments', 'text-gray-shade_e',
                    h('pre', {
                        class: {
                            'whitespace-pre-wrap': true,
                            'break-words': true,
                            'bg-accent-dark': true,
                            'p-2': true,
                            'rounded': true,
                            'text-gray-shade_e': true
                        }
                    }, JSON.stringify(message.tool_call_input, null, 2))
                    )
                ]));
            }
            
            if (message.role === 'tool') {
                const hasException = 'exception' in message.result_dict;
                const resultData = hasException ? message.result_dict.exception : message.result_dict.result;
                
                content.unshift(

                    h('div', {
                        class: {
                            'mb-2': true,
                            'font-bold': true,
                            'text-gray-shade_e': true
                        }
                    }, `Tool Output: ${message.tool_name}`),

                    createCollapsible(hasException ? 'View Exception' : 'View Results',  'text-gray-shade_e',
                        h('div', {
                            class: {
                                'bg-secondary_accent-dark': true,
                                'p-2': true,
                                'rounded': true,
                                'text-gray-shade_e': true
                            }
                        }, renderToolResult(resultData)),
                        message.for_whom === 'user'
                    )

                );
            }
             if (message.role === 'assistant' || message.role === 'tool') {
                content.push(createRatingButtons(message, index));
            }
            
            content.push(h('p', {
                class: {
                    'text-xs': true,
                    'mt-1.5': true,
                    'text-right': message.role === 'user'
                }
            }, new Date().toLocaleString()));

            const userSvg = h('svg', { 
                attrs: {
                    xmlns: 'http://www.w3.org/2000/svg',
                    viewBox: '0 0 26 26'
                },
                class: { 'w-6': true, 'h-6': true, 'fill-current': true, 'text-gray-shade_b': true }
                }, [
                h('path', { 
                    attrs: { 
                    d: "M16.0352 0.932185C19.1653 1.30585 21.474 2.60517 22.9611 4.83017C24.4657 7.0551 25.2179 9.62823 25.2179 12.5496C25.2179 16.1333 24.1284 19.2159 21.9495 21.7975C19.7705 24.3791 17.1679 25.6699 14.1415 25.6699C12.4641 25.6699 10.9336 25.2283 9.55025 24.3451C8.16677 23.445 7.2416 22.358 6.77475 21.0842C6.30784 19.8104 6.07438 18.0185 6.07438 15.7086V7.2759C6.07438 5.74727 5.92724 4.70272 5.63296 4.14227C5.33924 3.58178 4.7945 3.30153 3.99874 3.30153C2.8401 3.30153 2.07916 4.43948 1.7159 6.71538H0.782104C1.0068 2.85988 2.69291 0.932129 5.84044 0.932129C6.91256 0.932129 7.79452 1.20388 8.4863 1.74739C9.19531 2.29089 9.67953 2.91931 9.93895 3.63266C10.2157 4.32902 10.3541 5.61134 10.3541 7.47963V16.0398C10.3541 18.044 10.4664 19.5557 10.6911 20.5747C10.9333 21.5768 11.4608 22.4006 12.2735 23.046C13.1036 23.6914 14.0115 24.0141 14.9972 24.0141C16.6573 24.0141 17.9976 23.0715 19.0179 21.1862C20.0382 19.2839 20.5484 16.422 20.5484 12.6005C20.5484 9.18668 20.1679 6.67295 19.407 5.05934C18.646 3.42887 17.4701 2.35884 15.8791 1.84927L16.0352 0.932185Z"
                    }
                })
                ]);

            let aquiillmSvg = null;
            if (message.role === 'tool')
            {
                aquiillmSvg = h(
                    'svg', {
                        attrs: {
                            xmlns: 'http://www.w3.org/2000/svg',
                            viewBox: '0 0 32 26',
                        },
                    class:{ 'w-6': true, 'h-6': true, 'fill-current': true, 'text-secondary_accent': true }
                    }, [
                    h('path', {
                        attrs: {
                            d: "M24.8673 11.8191V11.4044L24.8558 10.9897L24.8329 10.598L24.81 10.2063L24.7299 9.44603L24.6383 8.73182L24.5009 8.04063L24.3521 7.38403L24.1803 6.76195L23.9743 6.17444L23.7567 5.62148L23.5048 5.09158L23.253 4.59624L22.9667 4.12393L22.6691 3.68617L22.3599 3.27148L22.0279 2.89131L21.6845 2.5342L21.341 2.20015L20.9746 1.90063L20.5968 1.62417L20.2075 1.37073L19.8183 1.14032L19.429 0.932974L19.0168 0.748654L18.6161 0.587361L18.2039 0.437599L17.7918 0.32243L17.3796 0.218757L16.9674 0.13811L16.5553 0.0804906L16.1431 0.034437L15.7424 0.011375L15.3417 -0.000120787L15.2845 1.26702C20.9288 1.26702 20.9288 8.78941 20.9288 13.2591C20.9288 15.3787 20.9288 18.7079 21.0433 19.6871C16.0286 24.0991 11.6322 24.7327 9.35383 24.7327C5.93057 24.7327 4.22469 22.1523 4.22469 18.4775C4.22469 15.6667 5.7016 9.46909 7.53344 6.54308C10.2125 2.3499 13.2923 1.26702 15.2845 1.26702L15.3417 -0.000120787C7.53345 -0.000120787 0 8.21344 0 16.3003C0 21.6339 3.42323 25.9999 9.23934 25.9999C12.8343 25.9999 16.9445 24.6751 21.2723 21.1731C22.0165 24.2143 23.8941 25.9999 26.4701 25.9999C29.4927 25.9999 31.2558 22.8435 31.2558 21.9219C31.2558 21.5187 30.9123 21.3459 30.5689 21.3459C30.1682 21.3459 29.9964 21.5187 29.8247 21.9219C28.8057 24.7327 26.7563 24.7327 26.6304 24.7327C24.8673 24.7327 24.8673 20.2631 24.8673 18.8807C24.8673 17.6711 24.8673 17.5675 25.4397 16.8763C30.7979 10.1027 32 3.44428 32 3.38668C32 3.27148 31.9428 2.8107 31.3131 2.8107C30.7406 2.8107 30.7406 2.98348 30.4544 4.02025C29.4354 7.63745 27.5464 11.9919 24.8673 15.3787V11.8191Z"
                        }
                    })
                ]);
            }
            else if (message.role === 'assistant')
            {
                aquiillmSvg = h(
                    'svg', {
                        attrs: {
                            xmlns: 'http://www.w3.org/2000/svg',
                            viewBox: '0 0 32 26',
                        },
                    class:{ 'w-6': true, 'h-6': true, 'fill-current': true, 'text-accent': true }
                    }, [
                    h('path', {
                        attrs: {
                            d: "M24.8673 11.8191V11.4044L24.8558 10.9897L24.8329 10.598L24.81 10.2063L24.7299 9.44603L24.6383 8.73182L24.5009 8.04063L24.3521 7.38403L24.1803 6.76195L23.9743 6.17444L23.7567 5.62148L23.5048 5.09158L23.253 4.59624L22.9667 4.12393L22.6691 3.68617L22.3599 3.27148L22.0279 2.89131L21.6845 2.5342L21.341 2.20015L20.9746 1.90063L20.5968 1.62417L20.2075 1.37073L19.8183 1.14032L19.429 0.932974L19.0168 0.748654L18.6161 0.587361L18.2039 0.437599L17.7918 0.32243L17.3796 0.218757L16.9674 0.13811L16.5553 0.0804906L16.1431 0.034437L15.7424 0.011375L15.3417 -0.000120787L15.2845 1.26702C20.9288 1.26702 20.9288 8.78941 20.9288 13.2591C20.9288 15.3787 20.9288 18.7079 21.0433 19.6871C16.0286 24.0991 11.6322 24.7327 9.35383 24.7327C5.93057 24.7327 4.22469 22.1523 4.22469 18.4775C4.22469 15.6667 5.7016 9.46909 7.53344 6.54308C10.2125 2.3499 13.2923 1.26702 15.2845 1.26702L15.3417 -0.000120787C7.53345 -0.000120787 0 8.21344 0 16.3003C0 21.6339 3.42323 25.9999 9.23934 25.9999C12.8343 25.9999 16.9445 24.6751 21.2723 21.1731C22.0165 24.2143 23.8941 25.9999 26.4701 25.9999C29.4927 25.9999 31.2558 22.8435 31.2558 21.9219C31.2558 21.5187 30.9123 21.3459 30.5689 21.3459C30.1682 21.3459 29.9964 21.5187 29.8247 21.9219C28.8057 24.7327 26.7563 24.7327 26.6304 24.7327C24.8673 24.7327 24.8673 20.2631 24.8673 18.8807C24.8673 17.6711 24.8673 17.5675 25.4397 16.8763C30.7979 10.1027 32 3.44428 32 3.38668C32 3.27148 31.9428 2.8107 31.3131 2.8107C30.7406 2.8107 30.7406 2.98348 30.4544 4.02025C29.4354 7.63745 27.5464 11.9919 24.8673 15.3787V11.8191Z"
                        }
                    })
                ]);
            }

            return h('div', { 
                class: { 
                    'flex': true,
                    'items-center': true, // â¬…ï¸ Centers the icon vertically with respect to the message
                    'justify-start': message.role !== 'user', // Aligns assistant/tool messages to the left
                    'justify-end': message.role === 'user', // Aligns user messages to the right
                    'gap-2': true // â¬…ï¸ Adds spacing between icon and message
                }
            }, [
                // For assistant/tool messages, place the avatar on the left
                message.role !== 'user' ? 
                    h('div', { class: { 'mr-2': true } }, aquiillmSvg) : null,
                h('div', { class: messageClasses }, content),

                // For user messages, place the avatar on the right
                message.role === 'user' ? 
                    h('div', { class: { 'ml-2': true } }, userSvg) : null
            ]);
        })
        ];
        
        if (shouldShowSpinner(data.messages)) {
            content.push(createSpinner());
        }
        
        return h('div', { 
            class: { 
                'gap-[32px]': true,
                'flex': true,
                'flex-col': true,
                'max-w-full': true,
                'h-full': true,
                'mx-auto': true,
                // 'overflow-y-auto': true
            }
        }, content);
    }
    
    let vnode = document.getElementById('conversation-root');
    let ws;
    let conversation = { messages: [] };
    let connectionAttempts = 0;
    const MAX_RECONNECTION_ATTEMPTS = 5;
    const CONNECTION_TIMEOUT = 5000; 
    
    
    function setInputState(disabled) {
        const input = document.getElementById('message-input');
        const button = document.getElementById('send-button');
        input.disabled = disabled;
        button.disabled = disabled;
    }
    
    
    function initWebSocket() {
        collections = fetchCollections()
        .then(data => {
            collections = data;
        });
        if (connectionAttempts >= MAX_RECONNECTION_ATTEMPTS) {
            updateExceptionBox('Maximum reconnection attempts reached. Please refresh the page.');
            return;
        }
        
        connectionAttempts++;
        updateExceptionBox('Attempting to connect... (Attempt ' + connectionAttempts + ' of ' + MAX_RECONNECTION_ATTEMPTS + ')');
        
        try {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';

            ws = new WebSocket(protocol + window.location.host + '/ws/convo/' + convo_id + '/');
            
            // Set connection timeout
            const timeoutId = setTimeout(() => {
                if (ws.readyState !== WebSocket.OPEN) {
                    ws.close();
                    updateExceptionBox('Connection timeout. Retrying...');
                    setTimeout(initWebSocket, 2000);
                }
            }, CONNECTION_TIMEOUT);
            
            ws.onopen = () => {
                console.log('Connected to chat server');
                clearTimeout(timeoutId);
                connectionAttempts = 0; // Reset counter on successful connection
                setInputState(false);
                updateExceptionBox(''); // Clear any existing error
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.exception) {
                        console.error('Server error:', data.exception);
                        updateExceptionBox(data.exception);
                        setInputState(false);
                        return;
                    }
                    
                    updateExceptionBox('');
                    
                    if (data.conversation) {
                        conversation = data.conversation;
                        updateConversation(conversation);
                        if (conversation.messages.length) {
                            const lastMessage = conversation.messages[conversation.messages.length - 1];
                            const shouldEnableInput = 
                            (lastMessage.role === 'assistant' && !lastMessage.tool_call_input) ||
                            (lastMessage.role === 'tool' && lastMessage.for_whom === 'user');
                            
                            setInputState(!shouldEnableInput);
                        }
                    }
                } catch (error) {
                    updateExceptionBox('Error processing message: ' + error.message);
                }
            };
            
            ws.onclose = (event) => {
                clearTimeout(timeoutId);
                console.log('Disconnected from chat server', event.code, event.reason);
                setInputState(true);
                
                let message = 'Disconnected from server. ';
                if (event.code === 1006) {
                    message += 'Abnormal closure. ';
                } else if (event.code === 1015) {
                    message += 'TLS handshake failed. ';
                }
                message += 'Attempting to reconnect...';
                
                updateExceptionBox(message);
                setTimeout(initWebSocket, 2000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateExceptionBox('Connection error occurred. Retrying...');
            };
            
        } catch (error) {
            console.error('Error creating WebSocket:', error);
            updateExceptionBox('Failed to create connection: ' + error.message);
            setTimeout(initWebSocket, 2000);
        }
    }
    
    function rateMessage(uuid, rating) {
        const payload = {
            action: 'rate',
            uuid: uuid,
            rating: rating,
        };
        
        ws.send(JSON.stringify(payload));
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        
        if (!message || !ws || ws.readyState !== WebSocket.OPEN) return;
        
        setInputState(true);
        conversation.messages.push({role: 'user', content: message});
        updateConversation(conversation);
        
        const payload = {
            action: 'append',
            message: conversation.messages.at(-1),
            collections: Array.from(selectedCollections)
        };
        
        ws.send(JSON.stringify(payload));
        input.value = '';
    }
    
    function updateConversation(newData) {
        vnode = patch(vnode, renderConversation(newData));
    }
    
    document.getElementById('send-button').addEventListener('click', sendMessage);
    
    document.getElementById('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    let selectedCollections = new Set();
    
    async function fetchCollections() {
        try {
            const response = await fetch("{% url 'get_collections_json' %}");
            if (!response.ok) {
                throw new Error(`Http error: ${response.status}`);
            }
            const data = await response.json();
            collections = data.collections;
            collections.forEach(collection => selectedCollections.add(collection.id));
            updateSelectedCount();
            renderCollections();
            updateSelectedCount();
            return collections;
        } catch (error) {
            console.error('Error fetching collections:', error)
            throw error;
        }
    }
    
    function renderCollections() {
        const container = document.getElementById('collections-list');
        container.innerHTML = '';
        
        collections.forEach(collection => {
            const div = document.createElement('div');
            div.className = 'flex items-center p-2 hover:bg-gray-50 rounded';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `collection-${collection.id}`;
            checkbox.className = 'h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500';
            checkbox.checked = selectedCollections.has(collection.id);
            
            const label = document.createElement('label');
            label.htmlFor = `collection-${collection.id}`;
            label.className = 'ml-2 text-sm text-gray-700';
            label.textContent = collection.name;
            
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    selectedCollections.add(collection.id);
                } else {
                    selectedCollections.delete(collection.id);
                }
                updateSelectedCount();
            });
            
            div.appendChild(checkbox);
            div.appendChild(label);
            container.appendChild(div);
        });
    }
    
    function updateSelectedCount() {
        const countElement = document.getElementById('selected-count');
        const count = selectedCollections.size;
        countElement.textContent = count ? `(${count} selected)` : '';
    }
    
    initWebSocket();
    
    window.updateConversation = updateConversation;
</script>
{% endblock %}